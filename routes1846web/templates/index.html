{% extends "layout.html" %}

{% block body %}
<h2>1846 Route Calculator</h2>
<ul class="nav nav-tabs" id="routes-tabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="placed-tiles-tab" data-toggle="tab" href="#placed-tiles" role="tab" aria-controls="placed-tiles" aria-selected="true">Placed Tiles</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="railroads-tab" data-toggle="tab" href="#railroads" role="tab" aria-controls="railroads" aria-selected="false">Railroads</a>
  </li>
  <li>
    <button id="calculate-submit" class="btn btn-success" data-toggle="modal" data-target="#routeModal" style="margin-left:10px;">Calculate</button>
  </li>
</ul>

<div class="tab-content" id="routes-tabs-content" style="margin-left: 50px; margin-top: 30px;">
  <div class="tab-pane fade show active" id="placed-tiles" role="tabpanel" aria-labelledby="placed-tiles-tab">
    <div style="float: left;" id="placed-tiles-table"></div>
    <div style="float: left; width: 50px;">&nbsp;</div>
    <div style="float: left;">
        <div>
            <span style="float: left; font-weight: bold;">coordinate -&nbsp;</span>
            <p style="float: left; width: 400px;">
                If your board doesn't have coordinates, refer to
                <a href="https://s3-us-west-2.amazonaws.com/gmtwebsiteassets/1846/1846_Map-FINAL72.jpg" target="_blank">one that does</a>.
            </p>
        </div>
        <div>
            <span style="float: left; font-weight: bold;">tile number -&nbsp;</span> <p style="float: left; width: 400px;">The ID number on the tile.</p>
        </div>
        <div>
            <span style="float: left; font-weight: bold;">orientation -&nbsp;</span>
            <div style="float: left; width: 400px;">
                <p>Number of counter-clockwise rotations to put the tile ID due south.</p>
                <p>For example, placing tile 8 at E13 in orientation 3 connects Toldeo and Fort Wayne.</p>
            </div>
        </div>
    </div>
  </div>
  <div class="tab-pane fade" id="railroads" role="tabpanel" aria-labelledby="railroads-tab">
    <div style="float: left;" id="railroads-table"></div>
    <div style="float: left; width: 50px;">&nbsp;</div>
    <div style="float: left;">
        <div>
            <span style="float: left; font-weight: bold;">chicago station side -&nbsp;</span>
            <div style="float: left; width: 400px;">
                <p>
                    Railroads with a station in Chicago (D6) indicate which "side" of the tile it's on, using the
                    same system as orientation.
                </p>
                <p>For example, the C & WI space is side 5.</p>
            </div>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="routeModal" tabindex="-1" role="dialog" aria-labelledby="routeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="form-group">
          <div>Best routes for</div> <select id="railroad-name" class="custom-select" style="width: 190px;"></select>
          <span id="reload-calculate" class="oi oi-reload" title="reload" aria-hidden="true" style="display: none;"></span>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul id="route-list"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
function getTrains(row) {
    var trainCells = row.slice(1, 5).filter(train => !isEmpty(train));
    return trainCells.length > 0 ? trainCells.join(",") : null
}

function calculate() {
    if (!readyToCalculate()) {
        return;
    }

    var postData = {
        "railroads-json": JSON.stringify(railroadsTableData.map(row => [row[0], getTrains(row), row[5], row[6]])),
        "board-state-json": JSON.stringify(placedTilesTableData),
        "railroad-name": $("#railroad-name").val()
    }
    $.post("{{ url_for('calculate') }}", postData)
        .done(function(resultJson) {
            if ("routes" in resultJson) {
                $("#route-list").empty();
                if (!Object.keys(resultJson["routes"]).length) {
                    $("<li />")
                        .text("No valid routes were found for the given configuration and railroad.")
                        .appendTo($("#route-list"));
                } else {
                    for (train in resultJson["routes"]) {
                        var trainRoute = resultJson["routes"][train];
                        $("<li />")
                            .text(train + ": " + trainRoute["route"].join(", ") + " (" + trainRoute["value"] + ")")
                            .appendTo($("#route-list"));
                    }
                }
            } else if ("error" in resultJson) {
                $("#route-list").empty();
                $("<div />")
                    .css("color", "red")
                    .text(resultJson["error"])
                    .appendTo($("#route-list"));
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            alert(textStatus);
        });
}


$("#railroad-name").change(function() {
    calculate();
    if (readyToCalculate()) {
        $("#reload-calculate").show();
    }
});
$("#reload-calculate").click(calculate);

function tileIdSourceFromCoord(coord) {
    return function (query, process) {
        $.get("{{ url_for('legal_tiles') }}", {coord: coord})
            .done(function(result) {
                process(result["legal-tile-ids"]);
            });
    }
}

function tileIdSource(row) {
    return function(query, process) {
        var source = tileIdSourceFromCoord(placedTilesTableData[row][0]);
        source(query, process);
    }
}

function orientationSourceFromCoord(coord, tileId) {
    return function(query, process) {
        $.get("{{ url_for('legal_orientations') }}", {coord: coord, tileId: tileId})
            .done(function(result) {
                process(result["legal-orientations"]);
            });
    }
}

function orientationSource(row) {
    return function(query, process) {
        var source = orientationSourceFromCoord(placedTilesTableData[row][0], placedTilesTableData[row][1]);
        source(query, process);
    }
}

function addPlacedTileSources(row) {
    placedTilesTable.setCellMeta(row, 1, "source", tileIdSource(row));
    placedTilesTable.setCellMeta(row, 2, "source", orientationSource(row));
}

function isEmpty(value) {
    return value === '' || value === null || value === undefined;
}

var TileEditor = createTileEditor("{{ url_for('static', filename='images') }}");
var OrientationEditor = createOrientationEditor("{{ url_for('static', filename='images') }}");

var placedTilesTableData = [new Array({{ placed_tiles_colnames | length }}).fill(null)];
var placedTilesTable = new Handsontable(document.getElementById("placed-tiles-table"), {
    data: placedTilesTableData,
    rowHeaders: false,
    colHeaders: {{ placed_tiles_colnames | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: {{ tile_coords | tojson | safe }}
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false,
            renderer: customTileDropdownRenderer("{{ url_for('static', filename='images') }}"),
            allowHtml: true
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false,
            renderer: customOrientationDropdownRenderer("{{ url_for('static', filename='images') }}"),
            allowHtml: true
        }
    ],
    afterChange: (changes, source) => {
        if (changes !== null) {
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    if (source !== "CopyPaste.paste") {
                        placedTilesTableData[row][1] = null;
                        placedTilesTableData[row][2] = null;
                        placedTilesTable.render();
                    }

                    placedTilesTable.setCellMeta(row, 1, "editor", isEmpty(newValue) ? false : TileEditor);
                    placedTilesTable.setCellMeta(row, 2, "editor", false);
                }

                if (col === 1) {
                    if (source !== "CopyPaste.paste") {
                        placedTilesTableData[row][2] = null;
                        placedTilesTable.render();
                    }

                    placedTilesTable.setCellMeta(row, 2, "editor", isEmpty(newValue) ? false : OrientationEditor);
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToSelectRailroad());
    },
    afterCreateRow: (index, amount) => {
        Array.from(new Array(amount).keys(), i => i + index).forEach(function(row) {
            addPlacedTileSources(row);
        });
    },
    beforePaste: function(data, pasteAreaArray) {
        var pasteArea = pasteAreaArray[0];

        var colNums = Array.from(new Array(data[0].length).keys(), i => i + pasteArea.startCol);

        // Remove all whitespace
        data.slice().forEach(function(row, index) {
            data.splice(index, 1, row.map(col => col.trim()));
        });

        data.slice().forEach(function(rowData, dataIndex) {
            var rowNum = dataIndex + pasteArea.startRow;
            var coord = colNums.includes(0) ? rowData[colNums.indexOf(0)] : placedTilesTableData[rowNum][0];
            var tileId = colNums.includes(1) ? parseInt(rowData[colNums.indexOf(1)], 10) : placedTilesTableData[rowNum][1];
            var orientation = colNums.includes(2) ? parseInt(rowData[colNums.indexOf(2)], 10) : placedTilesTableData[rowNum][2];

            if (colNums.includes(0)) {
                var legalValues = placedTilesTable.getCellMeta(rowNum, 0).source;
                if (!legalValues.includes(coord)) {
                    data.splice(dataIndex, 1, new Array(placedTilesTableData[0].length).fill(null));
                    return;
                }
            }
            if (colNums.includes(1)) {
                data[dataIndex][colNums.indexOf(1)] = tileId;

                var sourceFunc = tileIdSourceFromCoord(coord);
                sourceFunc("", function(legalValues) {
                    if (!legalValues.includes(tileId)) {
                        placedTilesTable.setDataAtCell(rowNum, 1, null, "edit");
                    }
                });
            }
            if (colNums.includes(2)) {
                data[dataIndex][colNums.indexOf(2)] = orientation;

                var sourceFunc = orientationSourceFromCoord(coord, tileId);
                sourceFunc("", function(legalValues) {
                    if (!legalValues.includes(orientation)) {
                        placedTilesTable.setDataAtCell(rowNum, 2, null, "edit");
                    }
                });
            }
        });
    }
});

// Needed to add sources to the initial row, since it doesn't trigger afterCreateRow
addPlacedTileSources(0);

{% set railroads_column_headers = [] -%}
{%- for colname in railroads_colnames -%}
{%- if colname == "trains" -%}
{{- railroads_column_headers.extend(["train1", "train2", "train3", "train4"]) or "" -}}
{%- else -%}
{{- railroads_column_headers.append(colname) or "" -}}
{%- endif -%}
{%- endfor -%}

function railroadSource(row) {
    return function(query, process) {
        var railroadNames = railroadsTableData.map(row => row[0]);
        $.get("{{ url_for('legal_railroads') }}", {railroads: JSON.stringify(railroadNames)})
            .done(function(result) {
                process(result["railroads"]);
            });
    }
}

function trainSource(row) {
    return function(query, process) {
        $.get("{{ url_for('trains') }}")
            .done(function(result) {
                process(result["trains"]);
            });
    }
}

function stationsSource(row) {
    return function(query, process) {
        $.get("{{ url_for('cities') }}")
            .done(function(result) {
                process(result["cities"]);
            });
    }
}

function chicagoStationSideSource(row) {
    return function(query, process) {
        var placedChicagoStations = railroadsTableData.map(row => row[3]);
        $.get("{{ url_for('chicago_stations') }}", {stations: JSON.stringify(placedChicagoStations)})
            .done(function(result) {
                process(result["chicago-stations"]);
            });
    }
}

function addRailroadSources(row) {
    railroadsTable.setCellMeta(row, 0, "source", railroadSource(row));
    railroadsTable.setCellMeta(row, 1, "source", trainSource(row));
    railroadsTable.setCellMeta(row, 2, "source", trainSource(row));
    railroadsTable.setCellMeta(row, 3, "source", trainSource(row));
    railroadsTable.setCellMeta(row, 4, "source", trainSource(row));
    railroadsTable.getCellMeta(row, 5).chosenOptions.data = stationsSource(row);
    railroadsTable.setCellMeta(row, 6, "source", chicagoStationSideSource(row));
}

var chicago = "D6";
var railroadsTableData = [new Array({{ railroads_column_headers | length }}).fill(null)];
var railroadsTable = new Handsontable(document.getElementById("railroads-table"), {
    data: railroadsTableData,
    rowHeaders: false,
    colHeaders: {{ railroads_column_headers | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            width: 170
        },
        {% for num in range(4) -%}
        {
            type: 'dropdown',
            allowInvalid: false,
            width: 60,
            source: [],
            editor: false
        },
        {% endfor -%}
        {
            type: "dropdown",
            allowInvalid: false,
            width: 180,
            chosenOptions: {
                multiple: true,
                data: []
            },
            editor: false
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false
        }
    ],
    afterCreateRow: (index, amount) => {
        Array.from(new Array(amount).keys(), i => i + index).forEach(function(row) {
            addRailroadSources(row);
        });
    },
    beforeChange: (changes) => {
        changes.slice().forEach(([row, col, oldValue, newValue], index) => {
            if (col === 5) {
                changes[index][3] = newValue.split(",").map(val => val.trim()).join(",");
            }
        });
    },
    afterChange: (changes) => {
        if (changes !== null) {
            if (changes.some(([row, col, oldValue, newValue]) => col === 0)) {
                var selectedRailroad = $("#railroad-name option:selected").val();
                var railroadNames = railroadsTableData.map(row => row[0]).filter(name => name);
    
                railroadNames = railroadNames.filter((name, index) => railroadNames.indexOf(name) >= index);
                railroadNames.sort();
    
                $("#railroad-name").empty();
                for (index in railroadNames) {
                    $("#railroad-name").append(
                        $("<option></option>")
                            .attr("name", railroadNames[index])
                            .text(railroadNames[index]));
                }
                $("#railroad-name").val(selectedRailroad);
            }
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    railroadsTable.setCellMeta(row, 1, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 2, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 3, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 4, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 5, "editor", isEmpty(newValue) ? false : "chosen");
                    if (newValue === '') {
                        railroadsTable.setCellMeta(row, 3, "editor", false);
                        railroadsTableData[row][1] = null;
                        railroadsTableData[row][2] = null;
                        railroadsTableData[row][3] = null;
                        railroadsTableData[row][4] = null;
                        railroadsTableData[row][5] = "";
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                } else if (col === 5) {
                    railroadsTable.setCellMeta(row, 6, "editor", newValue.split(",").includes(chicago) ? "dropdown" : false);
                    if (newValue !== chicago) {
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToSelectRailroad());
    },
    beforePaste: function(data, pasteAreaArray) {
        var pasteArea = pasteAreaArray[0];

        var colNums = Array.from(new Array(data[0].length).keys(), i => i + pasteArea.startCol);

        // Remove all whitespace
        data.slice().forEach(function(row, index) {
            data.splice(index, 1, row.map(col => col.trim()));
        });

        data.slice().forEach(function(rowData, dataIndex) {
            var rowNum = dataIndex + pasteArea.startRow;
            var name = colNums.includes(0) ? rowData[colNums.indexOf(0)] : railroadsTableData[rowNum][0];
            var trains = {
                1: colNums.includes(1) ? rowData[colNums.indexOf(1)] : railroadsTableData[rowNum][1],
                2: colNums.includes(2) ? rowData[colNums.indexOf(2)] : railroadsTableData[rowNum][2],
                3: colNums.includes(3) ? rowData[colNums.indexOf(3)] : railroadsTableData[rowNum][3],
                4: colNums.includes(4) ? rowData[colNums.indexOf(4)] : railroadsTableData[rowNum][4]
            };
            var stationsStr = colNums.includes(5) ? rowData[colNums.indexOf(5)] : railroadsTableData[rowNum][5];
            var stations = isEmpty(stationsStr) ? [] : stationsStr.split(",").map(station => station.trim());
            var chicagoStationSide = colNums.includes(6) ? parseInt(rowData[colNums.indexOf(6)], 10) : railroadsTableData[rowNum][6];

            if (colNums.includes(0)) {
                var legalValues = railroadsTable.getCellMeta(rowNum, 0).source;
                if (!legalValues.includes(name)) {
                    data.splice(dataIndex, 1, new Array(railroadsTable[0].length).fill(null));
                    return;
                }
            }

            Object.keys(trains).map(train => parseInt(train, 10)).forEach(colNum => {
                if (colNums.includes(colNum)) {
                    var sourceFunc = trainSource(rowNum);
                    sourceFunc("", function(legalValues) {
                        if (!legalValues.includes(trains[colNum])) {
                            railroadsTable.setDataAtCell(rowNum, colNum, null, "edit");
                        }
                    });
                }
            });

            if (colNums.includes(5)) {
                var sourceFunc = stationsSource(rowNum);
                sourceFunc("", function(legalValues) {
                    var legalStations = stations.filter(station => legalValues.includes(station));
                    // if (isEmpty(stations) || !stations.every(station => legalValues.includes(station))) {
                        railroadsTable.setDataAtCell(rowNum, 5, legalStations.join(","), "edit");
                    // }
                });
            }

            if (colNums.includes(6)) {
                data[dataIndex][colNums.indexOf(6)] = chicagoStationSide;

                var sourceFunc = chicagoStationSideSource(rowNum);
                sourceFunc("", function(legalValues) {
                    if (!legalValues.includes(chicagoStationSide)) {
                        railroadsTable.setDataAtCell(rowNum, 6, null, "edit");
                    }
                });
            }
        });
    }
});

addRailroadSources(0);


// Handsontable isn't properly displayed due to being hidden. Rendering once it's visible solves the problem.
$("#placed-tiles-tab").on("shown.bs.tab", function(e) {
    placedTilesTable.render();
});

$("#railroads-tab").on("shown.bs.tab", function(e) {
    railroadsTable.render();
});


function readyToSelectRailroad() {
    return placedTilesTableReady() &&
        railroadsTableReady();
}

function readyToCalculate() {
    return readyToSelectRailroad() &&
        railroadSelected();
}

function placedTilesTableReady() {
    return placedTilesTableData.length >= 2 &&
        placedTilesTableData.every((row) => {
            return row.every(col => !isEmpty(col)) ||
                   row.every(col => isEmpty(col));
        });
}

function railroadsTableReady() {
    return railroadsTableData.length >= 2 &&
        railroadsTableData.every(row =>
                row.every(column => isEmpty(column)) ||
                    (getTrains(row) !== null &&
                    !isEmpty(row[5]) &&
                    (!row[5].includes(chicago) || !isEmpty(row[6]))));
}

function railroadSelected() {
    var railroadNames = railroadsTableData.map(railroad => railroad[0]).filter(railroad => !isEmpty(railroad));
    return railroadNames.includes($("#railroad-name").val());
}

{% endblock %}