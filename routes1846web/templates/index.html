{% extends "layout.html" %}

{% block body %}
<h2>1846 Route Calculator</h2>
<ul class="nav nav-tabs" id="routes-tabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="placed-tiles-tab" data-toggle="tab" href="#placed-tiles" role="tab" aria-controls="placed-tiles" aria-selected="true">Placed Tiles</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="railroads-tab" data-toggle="tab" href="#railroads" role="tab" aria-controls="railroads" aria-selected="false">Railroads</a>
  </li>
  <li>
    <button id="calculate-submit" class="btn btn-success" data-toggle="modal" data-target="#routeModal" style="margin-left:10px;">Calculate</button>
  </li>
</ul>

<div class="tab-content" id="routes-tabs-content" style="margin-left: 50px; margin-top: 30px;">
  <div class="tab-pane fade show active" id="placed-tiles" role="tabpanel" aria-labelledby="placed-tiles-tab">
    <div id="placed-tiles-table"></div>
  </div>
  <div class="tab-pane fade" id="railroads" role="tabpanel" aria-labelledby="railroads-tab">
    <div id="railroads-table"></div>
  </div>
</div>

<div class="modal fade" id="routeModal" tabindex="-1" role="dialog" aria-labelledby="routeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="form-group">
          <div>Best routes for</div> <select id="railroad-name" class="custom-select" style="width: 190px;"></select>
          <span id="reload-calculate" class="oi oi-reload" title="reload" aria-hidden="true" style="display: none;"></span>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul id="route-list"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
function getTrains(row) {
    var trainCells = row.slice(1, 5).filter(train => !isEmpty(train));
    return trainCells.length > 0 ? trainCells.join(",") : null
}

function calculate() {
    if (!readyToCalculate()) {
        return;
    }

    var postData = {
        "railroads-json": JSON.stringify(railroadsTableData.map(row => [row[0], getTrains(row), row[5], row[6]])),
        "board-state-json": JSON.stringify(placedTilesTableData),
        "railroad-name": $("#railroad-name").val()
    }
    $.post("{{ url_for('calculate') }}", postData)
        .done(function(resultJson) {
            if ("routes" in resultJson) {
                $("#route-list").empty();
                if (!Object.keys(resultJson["routes"]).length) {
                    $("<li />")
                        .text("No valid routes were found for the given configuration and railroad.")
                        .appendTo($("#route-list"));
                } else {
                    for (train in resultJson["routes"]) {
                        var trainRoute = resultJson["routes"][train];
                        $("<li />")
                            .text(train + ": " + trainRoute["route"].join(", ") + " (" + trainRoute["value"] + ")")
                            .appendTo($("#route-list"));
                    }
                }
            } else if ("error" in resultJson) {
                $("#route-list").empty();
                $("<div />")
                    .css("color", "red")
                    .text(resultJson["error"])
                    .appendTo($("#route-list"));
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            alert(textStatus);
        });
}


$("#railroad-name").change(function() {
    calculate();
    if (readyToCalculate()) {
        $("#reload-calculate").show();
    }
});
$("#reload-calculate").click(calculate);

function addSources(placedTilesTable, placedTilesTableData, row) {
    placedTilesTable.setCellMeta(row, 1, "source", function(query, process) {
        var coord = placedTilesTableData[row][0];
        $.get("{{ url_for('legal_tiles') }}", {coord: coord})
            .done(function(result) {
                process(result["legal-tile-ids"]);
            });
    });
    placedTilesTable.setCellMeta(row, 2, "source", function(query, process) {
        var coord = placedTilesTableData[row][0];
        var tileId = placedTilesTableData[row][1];
        $.get("{{ url_for('legal_orientations') }}", {coord: coord, tileId: tileId})
            .done(function(result) {
                process(result["legal-orientations"]);
            });
    });
}

function isEmpty(value) {
    return value === '' || value === null || value === undefined;
}

var placedTilesTableData = [new Array({{ placed_tiles_colnames | length }}).fill(null)];
var placedTilesTable = new Handsontable(document.getElementById("placed-tiles-table"), {
    data: placedTilesTableData,
    rowHeaders: false,
    colHeaders: {{ placed_tiles_colnames | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: {{ tile_coords | tojson | safe }}
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false
        }
    ],
    afterChange: (changes, source) => {
        if (changes !== null) {
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    placedTilesTableData[row][1] = null;
                    placedTilesTableData[row][2] = null;
                    placedTilesTable.render();

                    placedTilesTable.setCellMeta(row, 1, "editor", isEmpty(newValue) ? false : "dropdown");
                    placedTilesTable.setCellMeta(row, 2, "editor", false);
                }

                if (col === 1) {
                    placedTilesTableData[row][2] = null;
                    placedTilesTable.render();

                    placedTilesTable.setCellMeta(row, 2, "editor", isEmpty(newValue) ? false : "dropdown");
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToSelectRailroad());
    },
    afterCreateRow: (index, amount) => {
        Array.from(new Array(amount).keys(), i => i + index).forEach(function(row) {
            addSources(placedTilesTable, placedTilesTableData, row);
        });
    }
});

// Needed to add sources to the initial row, since it doesn't trigger afterCreateRow
addSources(placedTilesTable, placedTilesTableData, 0);

{% set railroads_column_headers = [] -%}
{%- for colname in railroads_colnames -%}
{%- if colname == "trains" -%}
{{- railroads_column_headers.extend(["train1", "train2", "train3", "train4"]) or "" -}}
{%- else -%}
{{- railroads_column_headers.append(colname) or "" -}}
{%- endif -%}
{%- endfor -%}

var chicago = "D6";
var railroadsTableData = [new Array({{ railroads_column_headers | length }}).fill(null)];
var railroadsTable = new Handsontable(document.getElementById("railroads-table"), {
    data: railroadsTableData,
    rowHeaders: false,
    colHeaders: {{ railroads_column_headers | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: {{ railroad_names | tojson | safe }},
            width: 170
        },
        {% for num in range(4) -%}
        {
            type: 'dropdown',
            allowInvalid: false,
            width: 60,
            source: function(query, process) {
                $.get("{{ url_for('trains') }}")
                    .done(function(result) {
                        process(result["trains"]);
                    });
            },
            editor: false
        },
        {% endfor -%}
        {
            type: "dropdown",
            allowInvalid: false,
            width: 180,
            chosenOptions: {
                multiple: true,
                data: function(query, process) {
                    $.get("{{ url_for('cities') }}")
                        .done(function(result) {
                            process(result["cities"]);
                        });
                }
            },
            editor: false
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: function(query, process) {
                placedChicagoStations = railroadsTableData.map(row => row[3]);
                $.get("{{ url_for('chicago_stations') }}", {stations: JSON.stringify(placedChicagoStations)})
                    .done(function(result) {
                        process(result["chicago-stations"]);
                    });
            },
            editor: false
        }
    ],
    afterChange: (changes) => {
        if (changes !== null) {
            if (changes.some(([row, col, oldValue, newValue]) => col === 0)) {
                var selectedRailroad = $("#railroad-name option:selected").val();
                var railroadNames = railroadsTableData.map(row => row[0]).filter(name => name);
    
                railroadNames = railroadNames.filter((name, index) => railroadNames.indexOf(name) >= index);
                railroadNames.sort();
    
                $("#railroad-name").empty();
                for (index in railroadNames) {
                    $("#railroad-name").append(
                        $("<option></option>")
                            .attr("name", railroadNames[index])
                            .text(railroadNames[index]));
                }
                $("#railroad-name").val(selectedRailroad);
            }
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    railroadsTable.setCellMeta(row, 1, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 2, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 3, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 4, "editor", isEmpty(newValue) ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 5, "editor", isEmpty(newValue) ? false : "chosen");
                    if (newValue === '') {
                        railroadsTable.setCellMeta(row, 3, "editor", false);
                        railroadsTableData[row][1] = null;
                        railroadsTableData[row][2] = null;
                        railroadsTableData[row][3] = null;
                        railroadsTableData[row][4] = null;
                        railroadsTableData[row][5] = null;
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                } else if (col === 5) {
                    railroadsTable.setCellMeta(row, 6, "editor", newValue.split(",").includes(chicago) ? "dropdown" : false);
                    if (newValue !== chicago) {
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToSelectRailroad());
    }
});

// Handsontable isn't properly displayed due to being hidden. Rendering once it's visible solves the problem.
$("#placed-tiles-tab").on("shown.bs.tab", function(e) {
    placedTilesTable.render();
});

$("#railroads-tab").on("shown.bs.tab", function(e) {
    railroadsTable.render();
});


function readyToSelectRailroad() {
    return placedTilesTableReady() &&
        railroadsTableReady();
}

function readyToCalculate() {
    return readyToSelectRailroad() &&
        railroadSelected();
}

function placedTilesTableReady() {
    return placedTilesTableData.length >= 2 &&
        placedTilesTableData.every((row) => {
            return row.every(col => !isEmpty(col)) ||
                   row.every(col => isEmpty(col));
        });
}

function railroadsTableReady() {
    return railroadsTableData.length >= 2 &&
        railroadsTableData.every(row => isEmpty(row[5]) || !row[5].includes(chicago) || !isEmpty(row[6]));
}

function railroadSelected() {
    var railroadNames = railroadsTableData.map(railroad => railroad[0]).filter(railroad => !isEmpty(railroad));
    return railroadNames.includes($("#railroad-name").val());
}

{% endblock %}