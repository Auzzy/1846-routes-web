{% extends "layout.html" %}

{% block body %}
<div>
    <div style="float: left; margin-left: 100px;">
        <label style="display: block;">Placed Tiles</label>
        <div id="placed-tiles-table"></div>
    </div>
    <div style="float: left; margin-left: 100px;">
        <label style="display: block;">Railroads</label>
        <div id="railroads-table"></div>
    </div>
    <div style="float: left;  margin-left: 100px; margin-top: 30px;">
        <div style="float: left;">
            <div style="float: left;">
                <div class="form-group">
                    <select id="railroad-name" class="custom-select" style="width: 190px;"></select>
                </div>
            </div>
            <div style="float: left; margin-left: 50px;">
                <button id="calculate-submit" class="btn btn-primary">Calculate</button>
            </div>
        </div>
        <div style="clear: both;">&nbsp;</div>
        <div style="float: left;">
            <p>Routes</p>
            <ul id="route-list"></ul>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
function getTrains(row) {
    var trainCells = row.slice(1, 5).filter(train => train !== null);
    return trainCells.length > 0 ? trainCells.join(",") : null
}

$("#calculate-submit").click(function() {
    var postData = {
        "railroads-json": JSON.stringify(railroadsTableData.map(row => [row[0], getTrains(row), row[5], row[6]])),
        "board-state-json": JSON.stringify(placedTilesTableData),
        "railroad-name": $("#railroad-name").val()
    }
    $.post("{{ url_for('calculate') }}", postData)
        .done(function(resultJson) {
            for (train in resultJson) {
                $("<li />")
                    .text(train + ": " + resultJson[train]["route"].join(", ") + " (" + resultJson[train]["value"] + ")")
                    .appendTo($("#route-list"));
            }
        })
        .fail(function(jqXHR, textStatus) {
            alert(textStatus);
        });
});


function addSources(placedTilesTable, placedTilesTableData, row) {
    placedTilesTable.setCellMeta(row, 1, "source", function(query, process) {
        var coord = placedTilesTableData[row][0];
        $.get("{{ url_for('legal_tiles') }}", {coord: coord})
            .done(function(result) {
                process(result["legal-tile-ids"]);
            });
    });
    placedTilesTable.setCellMeta(row, 2, "source", function(query, process) {
        var coord = placedTilesTableData[row][0];
        var tileId = placedTilesTableData[row][1];
        $.get("{{ url_for('legal_orientations') }}", {coord: coord, tileId: tileId})
            .done(function(result) {
                process(result["legal-orientations"]);
            });
    });
}

var placedTilesTableData = [new Array({{ placed_tiles_colnames | length }}).fill(null)];
var placedTilesTable = new Handsontable(document.getElementById("placed-tiles-table"), {
    data: placedTilesTableData,
    rowHeaders: false,
    colHeaders: {{ placed_tiles_colnames | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: {{ tile_coords | tojson | safe }}
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: [],
            editor: false
        }
    ],
    afterChange: (changes, source) => {
        if (changes !== null) {
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    placedTilesTableData[row][1] = null;
                    placedTilesTableData[row][2] = null;
                    placedTilesTable.render();

                    placedTilesTable.setCellMeta(row, 1, "editor", newValue === '' ? false : "dropdown");
                    placedTilesTable.setCellMeta(row, 2, "editor", false);
                }

                if (col === 1) {
                    placedTilesTableData[row][2] = null;
                    placedTilesTable.render();

                    placedTilesTable.setCellMeta(row, 2, "editor", newValue === '' ? false : "dropdown");
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToCalculate());
    },
    afterCreateRow: (index, amount) => {
        Array.from(new Array(amount).keys(), i => i + index).forEach(function(row) {
            addSources(placedTilesTable, placedTilesTableData, row);
        });
    }
});

// Needed to add sources to the initial row, since it doesn't trigger afterCreateRow
addSources(placedTilesTable, placedTilesTableData, 0);

{% set railroads_column_headers = [] -%}
{%- for colname in railroads_colnames -%}
{%- if colname == "trains" -%}
{{- railroads_column_headers.extend(["train1", "train2", "train3", "train4"]) or "" -}}
{%- else -%}
{{- railroads_column_headers.append(colname) or "" -}}
{%- endif -%}
{%- endfor -%}

var chicago = "D6";
var railroadsTableData = [new Array({{ railroads_column_headers | length }}).fill(null)];
var railroadsTable = new Handsontable(document.getElementById("railroads-table"), {
    data: railroadsTableData,
    rowHeaders: false,
    colHeaders: {{ railroads_column_headers | tojson | safe }},
    startRows: 1,
    minSpareRows: 1,
    enterMoves: {row: 0, col: 1},
    columns: [
        {
            type: 'dropdown',
            allowInvalid: false,
            source: {{ railroad_names | tojson | safe }},
            width: 170
        },
        {% for num in range(4) -%}
        {
            type: 'dropdown',
            allowInvalid: false,
            width: 60,
            source: function(query, process) {
                $.get("{{ url_for('trains') }}")
                    .done(function(result) {
                        process(result["trains"]);
                    });
            },
            editor: false
        },
        {% endfor -%}
        {
            type: "dropdown",
            allowInvalid: false,
            width: 180,
            chosenOptions: {
                multiple: true,
                data: function(query, process) {
                    $.get("{{ url_for('cities') }}")
                        .done(function(result) {
                            process(result["cities"]);
                        });
                }
            },
            editor: false
        },
        {
            type: 'dropdown',
            allowInvalid: false,
            source: function(query, process) {
                placedChicagoStations = railroadsTableData.map(row => row[3]);
                $.get("{{ url_for('chicago_stations') }}", {stations: JSON.stringify(placedChicagoStations)})
                    .done(function(result) {
                        process(result["chicago-stations"]);
                    });
            },
            editor: false
        }
    ],
    afterChange: (changes) => {
        if (changes !== null) {
            if (changes.some(([row, col, oldValue, newValue]) => col === 0)) {
                var selectedRailroad = $("#railroad-name option:selected").val();
                var railroadNames = railroadsTableData.map(row => row[0]).filter(name => name);
    
                railroadNames = railroadNames.filter((name, index) => railroadNames.indexOf(name) >= index);
                railroadNames.sort();
    
                $("#railroad-name").empty();
                for (index in railroadNames) {
                    $("#railroad-name").append(
                        $("<option></option>")
                            .attr("name", railroadNames[index])
                            .text(railroadNames[index]));
                }
                $("#railroad-name").val(selectedRailroad);
            }
            changes.forEach(([row, col, oldValue, newValue]) => {
                if (col === 0) {
                    railroadsTable.setCellMeta(row, 1, "editor", newValue === '' ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 2, "editor", newValue === '' ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 3, "editor", newValue === '' ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 4, "editor", newValue === '' ? false : "dropdown");
                    railroadsTable.setCellMeta(row, 5, "editor", newValue === '' ? false : "chosen");
                    if (newValue === '') {
                        railroadsTable.setCellMeta(row, 3, "editor", false);
                        railroadsTableData[row][1] = null;
                        railroadsTableData[row][2] = null;
                        railroadsTableData[row][3] = null;
                        railroadsTableData[row][4] = null;
                        railroadsTableData[row][5] = null;
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                } else if (col === 5) {
                    railroadsTable.setCellMeta(row, 6, "editor", newValue.split(",").includes(chicago) ? "dropdown" : false);
                    if (newValue !== chicago) {
                        railroadsTableData[row][6] = null;
                        railroadsTable.render();
                    }
                }
            });
        }

        $("#calculate-submit").prop("disabled", !readyToCalculate());
    }
});

$("#railroad-name").change(function() {
    $("#calculate-submit").prop("disabled", !readyToCalculate());
});


function readyToCalculate() {
    return placedTilesTableReady() &&
        railroadsTableReady() &&
        railroadSelected();
}

function placedTilesTableReady() {
    return placedTilesTableData.length >= 2 &&
        placedTilesTableData.every((row) => {
            return row.every(col => col !== null) ||
                   row.every(col => col === null);
        });
}

function railroadsTableReady() {
    return railroadsTableData.length >= 2 &&
        railroadsTableData.every(row => row[5] === null || !row[5].includes(chicago) || row[6] !== null);
}

function railroadSelected() {
    var railroadNames = railroadsTableData.map(railroad => railroad[0]).filter(railroad => railroad !== null);
    return railroadNames.includes($("#railroad-name").val());
}

{% endblock %}