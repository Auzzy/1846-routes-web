var tilesTable = [];

function getTilesAsTable() {
    return tilesTable.slice();
}

function getTilesHeaders() {
    return {{ placed_tiles_colnames | tojson | safe  }};
}

function updateLocalStoragePlacedTiles() {
    if (typeof(Storage) !== "undefined") {
        localStorage.placedTilesTable = JSON.stringify(getTilesAsTable().filter(row => !row.every(isEmpty)));
    }
}

function loadFromLocalStoragePlacedTiles() {
    if (typeof(Storage) !== "undefined") {
        if (localStorage.placedTilesTable !== undefined) {
            tilesTable = JSON.parse(localStorage.placedTilesTable);
            drawMap();
        }
    }
}

function findNextEmptyRow() {
    for (row = 0; row < tilesTable.length; row++) {
        if (tilesTable[row].every(cell => isEmpty(cell))) {
            return row;
        }
    }
    return null;
}

function findRowByCoord(coord) {
    for (row = 0; row < tilesTable.length; row++) {
        if (tilesTable[row][0] === coord) {
            return row;
        }
    }
    return null;
}

function placeTile(coord, tileId, orientation) {
    if (tilesTable.some(row => row[0] === coord && row[1] === tileId && row[2] === orientation)) {
        return;
    }

    var row = findRowByCoord(coord);
    if (row === null) {
        // This coordinate isn't already represented, so get a new row.
        row = findNextEmptyRow();
    }

    tilesTable[row] = [coord, tileId, orientation];
}

function removeTile(coord) {
    var row = findRowByCoord(coord);
    if (row === null) {
        return;
    }

    tilesTable.splice(row, 1);
}

// Wait until the map has finished loading to draw the saved map. This is likely to kick in if a cache-refresh page
// reload is issued.
$("#placed-tiles-board").one("load", loadFromLocalStoragePlacedTiles);

// If the image was cached, it may be loaded by the time the above event is attached, so load the saved map immdeiately.
if ($("#placed-tiles-board").get(0).complete) {
    loadFromLocalStoragePlacedTiles();
}